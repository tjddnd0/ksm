<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="mobile-web-app-capable" content="yes">
        <meta http-equiv="Expires" content="-1">
        <link rel="manifest" href="./manifest.json">
        <link rel="stylesheet" href="./css/index.css?2024">
        <link rel="icon" href="./img/ksmicon.png">
        <link rel="apple-touch-icon" href="/img/logo.favicon.png">
        <title>KSM</title>
        <style>
        .splash {
            z-index: 10;
            position: fixed;
            width: 100vw;
            height: 100vh;
            position: fixed;
            background-color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.7s;
        }

        .splash-img {
            width: 500px;
            animation: fadein 0.7s;
            animation-play-state: running;
            animation-fill-mode: forwards;
        }

        @media (prefers-color-scheme: dark) {
            * {
                margin: 0px;
                padding: 0px;
            }

            body {
                background-color: #202124;
                color: white;
            }

            .splash {
                background-color: #202124;
            }
        }

        .BUT {
            width: 50px;
            height: 50px;
        }
        </style>
    </head>
    <body>
        <div class="content" style="display: none;">
            <div class="alert" style="display: none;"></div>
            <header>
                <div class="clock_div">
                    <div class="apm">오전</div>
                    <div class="clock">10 : 40</div>
                </div>
                <img
                    src="./img/ksmicon.png"
                    class="ksmicon"
                    style="height: 60px;"
                    onclick="reload()"
                >
            </header>
            <main>
                <div class="story">
                    <div
                        id="add"
                        class="right_list_item"
                        onClick="location.href='./page/storyedit.html'"
                        style="background-image: url('./img/edit.png');"
                    ></div>
                    <div class="right_list"></div>
                </div>
                <div class="content1">
                    <div class="widget meal_div">
                        <div class="mealtext"></div>
                        <div class="meal_left" onclick="optionClicked(this, 1);"></div>
                        <div class="meal_right" onclick="optionClicked(this, 2);"></div>
                        <div class="mealbackbutton">
                            <img src="./img/arrow-up-solid.svg" class="arrow" onclick="changearrow();">
                        </div>
                        <input
                            type="date"
                            id="inputdate"
                            class="inputdate"
                            onchange="apply_meal(0);"
                        >
                        <div class="mealtimebutton_div mealTime">
                            <div class="form_radio_btn radio_male">
                                <input
                                    id="radio-1"
                                    type="radio"
                                    name="mealtype"
                                    value="0"
                                    onclick="optionClicked(this, 0)"
                                >
                                <label for="radio-1">조식</label>
                            </div>
                            <div class="form_radio_btn">
                                <input
                                    id="radio-2"
                                    type="radio"
                                    name="mealtype"
                                    value="1"
                                    onclick="optionClicked(this, 0)"
                                >
                                <label for="radio-2">중식</label>
                            </div>
                            <div class="form_radio_btn">
                                <input
                                    id="radio-3"
                                    type="radio"
                                    name="mealtype"
                                    value="2"
                                    onclick="optionClicked(this, 0)"
                                >
                                <label for="radio-3">석식</label>
                            </div>
                        </div>
                    </div>
                    <div class="widget"></div>
                </div>
                <div class="content2">
                    <div class="widget function" style="height: auto;">
                        <function-widget data='["http://smart.cnehs.kr/main.do", "asmhomepage.svg", "학교 사이트 바로가기", "사이트로 이동합니다."]'></function-widget>
                        <function-widget data='["https://www.youtube.com/@user-qp4hz9hs9p", "youtube.svg", "학교 유튜브 보러가기", "사이트로 이동합니다."]'></function-widget>
                        <function-widget data='["https://asm.meistergo.co.kr/", "asmm.svg", "마이스터 되러가기", "사이트로 이동합니다."]'></function-widget>
                        <function-widget data='["https://chat.openai.com/", "chatgpt.svg", "ChatGPT 바로가기", "사이트로 이동합니다."]'></function-widget>
                        <function-widget data='["https://gemini.google.com/app?hl=ko", "bard.svg", "Gemini 바로가기", "사이트로 이동합니다."]'></function-widget>
                        <function-widget data='["https://www.classcard.net/", "classcard.svg", "클래스카드 바로가기", "사이트로 이동합니다."]'></function-widget>
                        <function-widget data='["/page/asmmeal.html", "mealsubmit.svg", "급식 신청하기", "페이지로 이동합니다."]'></function-widget>
                        <!-- <function-widget data='["about:blank", "book.svg", "도서관검색", "페이지로 이동합니다."]'></function-widget> -->
                        <function-widget data='["https://schoolbell-e.com/ko/main/home", "schoolpaper.svg", "학교종이 바로가기", "사이트로 이동합니다."]'></function-widget>
                        <function-widget data='["about:blank", "music.svg", "점호송 신청하기", "페이지로 이동합니다."]'></function-widget>
                        <function-widget data='["about:blank", "check.svg", "시설 확인하기", "페이지로 이동합니다."]'></function-widget>
                        <function-widget data='["https://www.q-net.or.kr/man004.do?id=manSubMain", "qnet.svg", "Qnet 바로가기", "사이트로 이동합니다."]'></function-widget>
                        <function-widget data='["https://license.korcham.net/indexmain.jsp", "korea.svg", "대한상공회의소 바로가기", "사이트로 이동합니다."]'></function-widget>
                        <function-widget data='["about:blank", "plusminus.svg", "상/벌점 확인하기", "페이지로 이동합니다."]'></function-widget>
                        <function-widget data='["about:blank", "cloud.svg", "파일 공유하기", "페이지로 이동합니다."]'></function-widget>
                        <function-widget data='["about:blank", "setting.svg", "앱 설정하기", "페이지로 이동합니다."]'></function-widget>
                    </div>
                </div>
            </main>
            <footer>
                <p>|&nbsp;</p>
                <a href="">서비스 소개</a>
                <p>&nbsp;|&nbsp;</p>
                <a href="https://mail.google.com/mail/?view=cm&to=8019jsw@naver.com&su=서비스 KSM 건의관련&body=건의 사항을 작성해주세요.">건의하기</a>
                <p>&nbsp;|&nbsp;</p>
                <a href="https://mail.google.com/mail/?view=cm&to=8019jsw@naver.com&su=서비스 KSM 버그제보&body=버그 사항을 작성해주세요.">버그제보</a>
                <p>&nbsp;|&nbsp;</p>
                <a href="https://mail.google.com/mail/?view=cm&to=8019jsw@naver.com&su=서비스 KSM 문의관련&body=문의 사항을 작성해주세요.">문의하기</a>
                <p>&nbsp;|</p>
            </footer>
            <div class="splash">
                <img src="./img/ksmicon.png" id="splash-img" height="20%">
            </div>
            <div class="modal_background" onclick="modalClose()"></div>
            <div class="expandUp modal_wrap">
                <div class="modal_close" onclick="modalClose()">
                    <img src="./img/close.svg" width="100%">
                </div>
                <div style="background-color: red;width: 100%;height: 100%;border: 1px solid black;">
                    <h1 class="modal_title">안녕하세요</h1>
                    <h3 class="modal_content">반갑습니다</h3>
                </div>
            </iframe>
        </div>
    </body>
    <script src="./js/index.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script src="./js/meal.js"></script>
    <script>
        const list = document.querySelector('.right_list');
        let isScrolling;
        let isScrollingLocked = false;
        const SCROLL_SPEED_MULTIPLIER = 2; // 스크롤 속도를 조절하기 위한 배율

        list.addEventListener('mouseenter', () => {
            document.html.style.overflowY = 'hidden';
        });

        list.addEventListener('mouseleave', () => {
            document.html.style.overflowY = 'scroll';
        });

        list.addEventListener('wheel', (event) => {
            if (isScrollingLocked) return;

            if (event.deltaY !== 0) {
                event.preventDefault();
                isScrollingLocked = true;
                list.scrollLeft += event.deltaY * SCROLL_SPEED_MULTIPLIER;

                clearTimeout(isScrolling);
                isScrolling = setTimeout(() => {
                    isScrollingLocked = false;
                }, 100); // 디바운스 딜레이를 조정할 수 있습니다.
            }
        });

        // Prevent body scroll when mouse is over scrollableDiv
        list.addEventListener('wheel', (event) => {
            event.preventDefault();
        }, { passive: false });

        const firebaseConfig = {
            apiKey: "AIzaSyAg-7fux86ZF0KfIkzCchO-sDyZ9_BJef8",
            authDomain: "kisuksasm.firebaseapp.com",
            projectId: "kisuksasm",
            storageBucket: "kisuksasm.appspot.com",
            messagingSenderId: "533806376102",
            appId: "1:533806376102:web:55ff491ecaeea82d9dc067",
            measurementId: "G-0V1M5LCDER"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const storageRef = storage.ref();
        const splash = document.querySelector(".splash");
        const content = document.querySelector(".content");

        window.addEventListener('load', function () {
            var timer = setTimeout(function () {
                splash.style.opacity = '0';
                content.style.display = 'grid';

                // 스플래시 화면을 숨기기 위해 페이드 아웃이 완료되면 display: none으로 변경
                setTimeout(function () {
                    splash.style.display = 'none';
                }, 700); // 0.8초 후에 스플래시 화면 숨김
                clearTimeout(timer);
            }, 500); // 2초 후에 스플래시 화면 페이드 아웃 시작
        });

        window.addEventListener('popstate', function (event) {
            modalClose();
        });

        class 클래스 extends HTMLElement {
            connectedCallback() {
                const itemdata = this.getAttribute('data');
                const items = JSON.parse(itemdata);
                this.innerHTML = '<div class="function_item" onclick="location.href=\'' + items[0] + '\'">\
                    <div class="function_item_img">\
                    <img src="./img/function/'+ items[1] + '" class="function_item_img"\
                    width="100%""></div>\
                    <div class="function_item_title">\
                    <div class="function_item_main">'+ items[2] + '</div>\
                    </div></div>';
            }
        }

        customElements.define('function-widget', 클래스);

        function readData() {
            // 데이터 가져오기
            db.collection("storys")
            .get()
            .then((querySnapshot) => {
                querySnapshot.forEach((doc) => {
                var 템플릿 = `<div id="${doc.id}" class="right_list_item" onClick="javascript:story('${doc.id}')" style="background-image: url('${doc.data().사진}');">
                            <div class="right_list_item_title">${doc.data().제목}</div></div>`;
                            document.querySelector(".right_list").innerHTML += 템플릿;
                console.log(doc.id, " => ", doc.data());
                });
            })
            .catch((error) => {
                console.error("Error getting documents: ", error);
            });
        }
        readData();

        function story(docId) {
            db.collection("storys")
            .doc(String(docId))
            .get()
            .then((doc) => {
                document.querySelector(".modal_title").innerHTML = doc.data().제목;
                document.querySelector(".modal_content").innerHTML = doc.data().내용;

                console.log("선택 스토리 제목 => ",doc.data().제목);
            });
            modalOpen();
        }

        const modal_wrap = document.querySelector(".modal_wrap");
        const modal_background = document.querySelector(".modal_background");
        const html = document.querySelector("html");
        const story_iframe = document.querySelector(".story-iframe");

        // 모달 열기
        function modalOpen() {
            window.history.pushState(null, null, window.location.href);
            modal_wrap.style.display = 'block';
            modal_background.style.display = 'block';
            html.style.overflowY = 'hidden';
        }

        // 모달 끄기
        function modalClose() {
            modal_wrap.style.display = 'none';
            modal_background.style.display = 'none';
            html.style.overflowY = 'auto';
            story_iframe.src = 'about:blank';
        }

        function handleIFrameURLChange() {
            var currentURL = story_iframe.contentWindow.location.href;

            if (currentURL === "about:blank") {
                modalClose();
            }
        }

        function fromAppToWeb(msg) {
            document.querySelector('.flutterMessageTitle').innerHTML = msg;
        }

        function fromWebToApp(msg) {
            var now = new Date();	// 현재 날짜 및 시간
            //toApp.postMessage('' + now);
            toApp.postMessage(msg);
        }

        function updateTime() {
            // 한국 표준시(KST)로 시간 설정
            const options = { timeZone: 'Asia/Seoul', hour12: true };
            const now = new Date();
            const kstTime = now.toLocaleTimeString('ko-KR', options);
            const [ampm, time] = kstTime.split(' ');

            document.querySelector('.clock').innerText = time;
            document.querySelector('.apm').innerText = ampm;
        }

        // 초마다 시간 업데이트
        setInterval(updateTime, 1000);
        updateTime(); // 페이지 로드 시 바로 시간 표시
    </script>
</html>
